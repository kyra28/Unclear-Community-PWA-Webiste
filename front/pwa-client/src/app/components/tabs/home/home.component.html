<!-- Render JavaScript alerts here -->
<div class="alert-area"></div>

<section class="page page-news page-news-show-stream">
  <div class="items">
    <div *ngFor="let news of this.newsList">
        <div class="item news">
            <a class="image text-hide" [routerLink]="['/news',this.news.id]" style="background-image: url({{this.news.image}}">
            </a>
            
            <h2 title="{{this.news.title}}">
                <a [routerLink]="['/news',this.news.id]">{{this.news.title}}</a>
            </h2>
          
            <div class="meta below">
                <time>{{this.news.publishedAt | date : "MMMM d, y"}}</time> - {{this.news.admin.pseudo}}
            </div>
          </div>
    </div>
  </div>

  <div class="clearfix"></div>

  <div class="loading hidden text-center"><i class="fas fa-spinner fa-spin"></i> Chargementâ€¦</div>

  <script>
    $(document).ready(function()
    {
      var timestamp = 0;
      var loading = false;
      var lastScrollTop = 0;

      $(document).scroll(function()
      {
        var scrollTop = $(this).scrollTop();

        if (scrollTop < lastScrollTop || ! 0) {
          return;
        }
        lastScrollTop = scrollTop;

        var scrollBottom = scrollTop + $(window).height();

        var $lastItem = $('.page .item').last();
        if ($lastItem.length > 0) {
          var lastItemBottom = $lastItem.offset().top + $lastItem.height();

          if (scrollBottom > lastItemBottom) {
            timestamp = parseInt($lastItem.attr('data-timestamp')) - 1;

            if (! loading) {
              loading = true;
              $('.page .loading').removeClass('hidden');

              $.get(contentify.baseUrl + 'news/showStream/' + timestamp, function(data)
              {
                var $items = $(data).addClass('new');
                $('.page .items').append($items).append('<div class="bugfix"></div>');
                $('.page .items .bugfix').last().hide().show(0); // Force browsers to show CSS transitions
                $items.removeClass('new');
              }).always(function()
              {
                if ($('.page .items .item').last().attr('data-more') == 1) {
                  loading = false;
                }
                $('.page .loading').addClass('hidden');
              });
            }
          }
        }

      });
    });
  </script>

</section>